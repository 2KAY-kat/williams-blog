import{s as u,B as p}from"./utils-CTkCsTWQ.js";import"./auth-check-C3ob4bUA.js";const g=localStorage.getItem("auth_token");g||(window.location.href="../auth/signup.html");let E=null,I=null,w=null;function C(){const e=document.getElementById("loading-spinner");e&&e.classList.remove("hidden")}function b(){const e=document.getElementById("loading-spinner");e&&e.classList.add("hidden")}try{E=JSON.parse(atob(g.split(".")[1])).data.id}catch(e){console.error("Invalid token format:",e),localStorage.removeItem("auth_token"),window.location.href="../auth/signup.html"}const $="dashboard_active_view";function T(e){try{localStorage.setItem($,e)}catch(t){console.warn("Failed to save active view:",t)}}function _(){try{return localStorage.getItem($)||"home"}catch(e){return console.warn("Failed to retrieve active view:",e),"home"}}function h(e,t){const o=document.querySelectorAll(".view"),r=document.getElementById(`${e}-view`);if(!r){console.error(`View ${e}-view not found`);return}o.forEach(s=>{s.classList.remove("active")}),r.classList.add("active"),t.forEach(s=>{s.dataset.view===e?s.classList.add("active"):s.classList.remove("active")});let n="Home";e==="posts"?n="My Posts":e==="write"?n="Write":e==="profile"?n="Profile":e==="subscribers"&&(n="Subscribers"),document.getElementById("page-title").textContent=n,T(e),e==="posts"?S():e==="profile"?L():e==="write"&&(D(I),I=null)}document.addEventListener("DOMContentLoaded",()=>{b();const e=document.querySelectorAll(".nav-link"),t=document.getElementById("post-form"),o=document.getElementById("add-post-btn"),r=document.getElementById("logout-btn"),n=document.getElementById("close-write-btn"),s=document.getElementById("cancel-post-btn");e.forEach(a=>{a.addEventListener("click",d=>{if(a.id==="logout-btn")return;d.preventDefault();const m=a.dataset.view;h(m,e)})}),o.addEventListener("click",()=>{h("write",e)}),n.addEventListener("click",()=>{h("posts",e)}),s.addEventListener("click",()=>{h("posts",e)}),t.addEventListener("submit",H),document.addEventListener("click",a=>{if(a.target.closest(".btn-edit")){a.preventDefault();const m=a.target.closest(".post-card")?.dataset.postId;m&&j(parseInt(m))}if(a.target.closest(".btn-delete")){a.preventDefault();const m=a.target.closest(".post-card")?.dataset.postId;m&&k(parseInt(m))}}),r.addEventListener("click",a=>{a.preventDefault(),localStorage.removeItem("auth_token"),localStorage.removeItem($),u("Logged out successfully.","success"),setTimeout(()=>window.location.href="../auth/signup.html",1e3)}),M(),W(),J(),document.querySelectorAll(".onboarding-btn").forEach(a=>{a.addEventListener("click",()=>{const d=a.dataset.action;h(d,e)})});const i=_();h(i,e);const l=document.getElementById("delete-modal"),f=document.getElementById("delete-cancel-btn"),c=document.getElementById("delete-confirm-btn");f&&f.addEventListener("click",B),l&&l.addEventListener("click",a=>{a.target===l&&B()}),c&&c.addEventListener("click",async()=>{if(!w)return;const a=c.innerHTML;c.disabled=!0,c.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{const d=await fetch(`${p}/posts/${w}`,{method:"DELETE",headers:{Authorization:`Bearer ${g}`}});if(!d.ok){const m=await d.json();throw new Error(m.error||"Delete failed")}u("Post deleted successfully!","success"),B(),S()}catch(d){console.error("Error deleting post:",d),u(`Error: ${d.message}`,"error")}finally{c.disabled=!1,c.innerHTML=a}}),document.addEventListener("click",a=>{if(a.target.closest(".btn-delete")){a.preventDefault();const m=a.target.closest(".post-card")?.dataset.postId;m&&k(parseInt(m))}})});function D(e=null){const t=document.getElementById("post-form"),o=document.getElementById("write-title"),r=document.getElementById("write-subtitle");if(t.reset(),t.postid.value="",document.querySelector(".btn-text").textContent="Save Post",e){o.textContent="Edit Post",r.textContent="Update your post",t.title.value=e.title||"",t.content.value=e.content||"",t.ispublished.checked=e.ispublished===1||e.ispublished===!0,t.postid.value=e.postid;const i=e.main_image_url;i&&(document.getElementById("current-image-url").value=i,document.getElementById("image-preview-text").textContent=`Current: ${i.split("/").pop()}`,document.getElementById("image-preview-text").style.display="block")}else o.textContent="New Post",r.textContent="Share your thoughts with the world",document.getElementById("image-preview-text").style.display="none";const n=document.getElementById("categories-checkboxes"),s=e?.categories||[];n.innerHTML=y.map(i=>{const l=s.includes(i.name);return`
            <label>
                <input type="checkbox" class="category-checkbox" name="categories" value="${i.category_id}" 
                ${l?"checked":""}>
                ${i.name}
            </label>
        `}).join("")}async function S(){C();const e=document.getElementById("posts-container");try{const t=await fetch(`${p}/posts?blogger_id=${E}`,{headers:{Authorization:`Bearer ${g}`}});if(!t.ok){const n=await t.json();throw new Error(n.error||"Failed to load posts")}const o=await t.json();if(!Array.isArray(o))throw new Error("Invalid posts data");if(e.innerHTML="",o.length===0){e.innerHTML=`
            <a href="#" class="addpost-card" onclick="document.getElementById('add-post-btn').click(); return false;"> <div class="onboarding-card">
                <div class="card-icon write-icon">
                  <i class="fas fa-pen-fancy"></i>
                </div>
                <h3>Create Your First Post</h3>
                <!-- <p>Share your thoughts, ideas, and expertise with your audience</p>
                <button class="onboarding-btn" data-action="write">
                  Start Writing
                  <i class="fas fa-arrow-right"></i>
                </button> -->
              </div>
              </a>`,b();return}const r=o.map(n=>`
            <div class="post-card" data-post-id="${n.postid}">
                <div class="post-card-header">
                    <h4 class="posts-heading-prev">${n.title}</h4>
                </div>
                <div class="post-card-body">
                    <p class="posts-content-prev">${n.content_preview||n.content}</p>
                </div>
                <div class="post-card-footer">
                    <div class="details-meta">
                        <small><i class="fas fa-calendar"></i> ${new Date(n.created_at).toLocaleDateString()}</small>
                        <span class="status ${n.ispublished?"published":"draft"}">
                            <i class="fas"></i> ${n.ispublished?"Published":"Draft"}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn-edit" type="button" title="Edit post">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" type="button" title="Delete post">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `).join("");e.innerHTML=r}catch(t){console.error("Error loading posts:",t),e.innerHTML=`<p style="padding: 32px; text-align: center; grid-column: 1/-1; color: #d32f2f;">Error loading posts: ${t.message}</p>`}finally{b()}}let y=[];async function M(){try{const e=await fetch(`${p}/categories`);if(!e.ok)throw new Error(`Failed to fetch categories: ${e.status}`);if(y=await e.json(),!Array.isArray(y))throw new Error("Categories response is not an array");console.log(`Successfully loaded ${y.length} categories`)}catch(e){console.error("Failed to load categories:",e),u("Failed to load categories.","error")}}async function H(e){e.preventDefault();const t=e.target,o=t.querySelector('button[type="submit"]');if(!o){console.error("Submit button not found");return}const r=o.querySelector(".btn-text"),n=o.querySelector(".btn-spinner");o.disabled=!0,r&&(r.textContent="Saving..."),n&&(n.style.display="inline-block");try{const s=new FormData;s.append("title",t.title.value.trim()),s.append("content",t.content.value.trim()),s.append("is_published",t.ispublished.checked?1:0),Array.from(t.querySelectorAll('input[name="categories"]:checked')).map(v=>parseInt(v.value)).forEach(v=>s.append("categories[]",v));const l=document.getElementById("image-file-input"),f=document.getElementById("current-image-url"),c=f?f.value:"";l&&l.files.length>0?s.append("image_file",l.files[0]):c&&s.append("main_image_url",c);const a=t.postid.value,d=a?`${p}/posts/${a}`:`${p}/posts`;a&&s.append("_method","PUT");const m=await fetch(d,{method:"POST",headers:{Authorization:`Bearer ${g}`},body:s}),A=await m.json();if(!m.ok)throw new Error(A.error||"Failed to save post");u(`Post ${a?"updated":"created"} successfully!`,"success"),t.reset();const x=document.querySelectorAll(".nav-link");h("posts",x),S()}catch(s){console.error("Error submitting post:",s),u(`Error: ${s.message}`,"error")}finally{o.disabled=!1,r&&(r.textContent="Save Post"),n&&(n.style.display="none")}}async function j(e){C();try{const t=await fetch(`${p}/posts/${e}`,{headers:{Authorization:`Bearer ${g}`}});if(!t.ok){const n=await t.json();throw new Error(n.error||"Failed to fetch post")}const o=await t.json();console.log("Editing post:",o),I=o;const r=document.querySelectorAll(".nav-link");h("write",r)}catch(t){console.error("Error editing post:",t),u(`Error: ${t.message}`,"error")}finally{b()}}async function k(e){w=e;try{const t=await fetch(`${p}/posts/${e}`,{headers:{Authorization:`Bearer ${g}`}});if(!t.ok)throw new Error("Failed to fetch post");const o=await t.json();document.getElementById("delete-post-title").textContent=o.title,document.getElementById("delete-post-date").textContent=`Created on ${new Date(o.created_at).toLocaleDateString()}`,F()}catch(t){console.error("Error fetching post:",t),u("Error loading post details","error")}}function F(){const e=document.getElementById("delete-modal");e&&(e.classList.remove("hidden"),document.body.style.overflow="hidden")}function B(){const e=document.getElementById("delete-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="auto"),w=null}async function L(){try{const e=await fetch(`${p}/blogger`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok){const s=await e.json();throw new Error(s.error||"Failed to load profile")}const t=await e.json(),o=document.getElementById("profile-display-name"),r=document.getElementById("profile-display-email");o&&(o.textContent=t.full_name||"Blogger"),r&&(r.textContent=t.email||"");const n=document.getElementById("account-form");n&&(n.full_name.value=t.full_name||"",n.email.value=t.email||"",n.username.value=t.username||"",n.phone.value=t.phone||"",n.bio.value=t.bio||"",n.website.value=t.website||"",P()),z(),U(),O(),q()}catch(e){console.error("Error loading profile:",e),u(`Error: ${e.message}`,"error")}}function q(){const e=document.querySelectorAll(".profile-tab-btn"),t=document.querySelectorAll(".profile-tab-content");e.forEach(o=>{o.addEventListener("click",()=>{const r=o.dataset.tab;e.forEach(n=>n.classList.remove("active")),o.classList.add("active"),t.forEach(n=>n.classList.remove("active")),document.getElementById(`${r}-tab`).classList.add("active")})})}function z(){const e=document.getElementById("account-form");if(!e)return;const t=e.bio;t&&t.addEventListener("input",P),e.addEventListener("submit",async r=>{r.preventDefault();const n=e.querySelector('button[type="submit"]'),s=n.innerHTML;n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';try{const i={full_name:e.full_name.value.trim(),email:e.email.value.trim(),username:e.username.value.trim(),phone:e.phone.value.trim()||null,bio:e.bio.value.trim()||null,website:e.website.value.trim()||null},l=await fetch(`${p}/blogger`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify(i)});if(!l.ok){const f=await l.json();throw new Error(f.error||"Update failed")}u("Profile updated successfully!","success"),L()}catch(i){console.error("Error updating profile:",i),u(`Error: ${i.message}`,"error")}finally{n.disabled=!1,n.innerHTML=s}});const o=document.getElementById("reset-account-btn");o&&o.addEventListener("click",()=>{L()})}function U(){const e=document.getElementById("toggle-password-form"),t=document.getElementById("password-form"),o=document.getElementById("cancel-password-btn");e&&e.addEventListener("click",()=>{t.classList.toggle("hidden"),e.textContent=t.classList.contains("hidden")?"Change Password":"Hide"}),o&&o.addEventListener("click",()=>{t.classList.add("hidden"),e&&(e.textContent="Change Password"),t.reset()}),document.querySelectorAll(".password-toggle").forEach(s=>{s.addEventListener("click",i=>{i.preventDefault();const l=s.dataset.target,f=document.getElementById(l),c=f.type==="password";f.type=c?"text":"password",s.innerHTML=c?'<i class="fas fa-eye-slash"></i>':'<i class="fas fa-eye"></i>'})});const r=document.getElementById("new-password");r&&r.addEventListener("input",V),t.addEventListener("submit",async s=>{s.preventDefault();const i=document.getElementById("current-password").value,l=document.getElementById("new-password").value,f=document.getElementById("confirm-password").value;if(l!==f){u("New passwords do not match","error");return}if(l.length<8){u("Password must be at least 8 characters","error");return}const c=t.querySelector('button[type="submit"]'),a=c.innerHTML;c.disabled=!0,c.innerHTML='<i class="fas fa-spinner fa-spin"></i> Updating...';try{const d=await fetch(`${p}/admin/change-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify({current_password:i,new_password:l})});if(!d.ok){const m=await d.json();throw new Error(m.error||"Password update failed")}u("Password updated successfully!","success"),t.reset(),t.classList.add("hidden"),document.getElementById("toggle-password-form").textContent="Change Password"}catch(d){console.error("Error updating password:",d),u(`Error: ${d.message}`,"error")}finally{c.disabled=!1,c.innerHTML=a}});const n=document.getElementById("enable-2fa-btn");n&&n.addEventListener("click",()=>{u("Two-factor authentication is coming soon!","info")})}function O(){const e=document.getElementById("preferences-form");e&&e.addEventListener("click",()=>{u("Preference settings comming soon!","info")});const t=document.getElementById("delete-account-btn");t&&t.addEventListener("click",()=>{u("Account deletion is coming soon","info")})}function P(){const e=document.getElementById("profile-bio"),t=document.getElementById("bio-char-count");e&&t&&(t.textContent=e.value.length)}function V(){const e=document.getElementById("new-password").value,t=document.getElementById("strength-indicator"),o=document.getElementById("strength-text");let r="Weak",n="weak";if(e.length>=8){const s=/[A-Z]/.test(e),i=/[a-z]/.test(e),l=/[0-9]/.test(e),f=/[!@#$%^&*]/.test(e),c=[s,i,l,f].filter(Boolean).length;c>=3?(r="Strong",n="strong"):c>=2&&(r="Medium",n="medium")}t.className=`strength-indicator ${n}`,o.textContent=`Password strength: ${r}`}async function W(){try{const e=await fetch(`${p}/blogger`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok)return;const t=await e.json(),o=document.getElementById("blogger-name");o&&t.full_name&&(o.textContent=t.full_name.split(" ")[0])}catch(e){console.error("Error loading blogger name:",e)}}async function J(){try{const e=await fetch(`${p}/posts?blogger_id=${E}`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok)return;const t=await e.json();if(!Array.isArray(t))return;const o=t.length,r=t.filter(i=>i.ispublished===1||i.ispublished===!0).length,n=document.getElementById("stat-posts"),s=document.getElementById("stat-published");n&&(n.textContent=o),s&&(s.textContent=r),R()}catch(e){console.error("Error loading dashboard stats:",e)}}async function R(){try{const e=await fetch(`${p}/subscribers?blogger_id=${E}`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok)return;const t=await e.json(),o=Array.isArray(t)?t.length:0,r=document.getElementById("stat-subscribers");r&&(r.textContent=o)}catch{console.log("Note: Subscriber endpoint may not be available yet")}}
