import{s as l,B as p}from"./utils-TR1j_de-.js";import"./auth-check-cRqyrRfN.js";const g=localStorage.getItem("auth_token");g||(window.location.href="../auth/signup.html");let v=null,I=null,w=null;function S(){const e=document.getElementById("loading-spinner");e&&e.classList.remove("hidden")}function E(){const e=document.getElementById("loading-spinner");e&&e.classList.add("hidden")}try{v=JSON.parse(atob(g.split(".")[1])).data.id}catch(e){console.error("Invalid token format:",e),localStorage.removeItem("auth_token"),window.location.href="../auth/signup.html"}const $="dashboard_active_view";function _(e){try{localStorage.setItem($,e)}catch(t){console.warn("Failed to save active view:",t)}}function D(){try{return localStorage.getItem($)||"home"}catch(e){return console.warn("Failed to retrieve active view:",e),"home"}}function y(e,t){const o=document.querySelectorAll(".view"),s=document.getElementById(`${e}-view`);if(!s){console.error(`View ${e}-view not found`);return}o.forEach(r=>{r.classList.remove("active")}),s.classList.add("active"),t.forEach(r=>{r.dataset.view===e?r.classList.add("active"):r.classList.remove("active")});let n="Home";e==="posts"?n="My Posts":e==="write"?n="Write":e==="profile"?n="Profile":e==="subscribers"&&(n="Subscribers"),document.getElementById("page-title").textContent=n,_(e),e==="posts"?C():e==="profile"?L():e==="write"&&(M(I),I=null)}document.addEventListener("DOMContentLoaded",()=>{E();const e=document.querySelectorAll(".nav-link"),t=document.getElementById("post-form"),o=document.getElementById("add-post-btn"),s=document.getElementById("logout-btn"),n=document.getElementById("close-write-btn"),r=document.getElementById("cancel-post-btn");e.forEach(i=>{i.addEventListener("click",d=>{if(i.id==="logout-btn")return;d.preventDefault();const m=i.dataset.view;y(m,e)})}),o.addEventListener("click",()=>{y("write",e)}),n.addEventListener("click",()=>{y("posts",e)}),r.addEventListener("click",()=>{y("posts",e)}),t.addEventListener("submit",j),document.addEventListener("click",i=>{if(i.target.closest(".btn-edit")){i.preventDefault();const m=i.target.closest(".post-card")?.dataset.postId;m&&F(parseInt(m))}if(i.target.closest(".btn-delete")){i.preventDefault();const m=i.target.closest(".post-card")?.dataset.postId;m&&q(parseInt(m))}}),s.addEventListener("click",i=>{i.preventDefault(),localStorage.removeItem("auth_token"),localStorage.removeItem($),l("Logged out successfully.","success"),setTimeout(()=>window.location.href="../auth/signup.html",1e3)}),H(),R(),N(),document.querySelectorAll(".onboarding-btn").forEach(i=>{i.addEventListener("click",()=>{const d=i.dataset.action;y(d,e)})});const u=D();y(u,e);const a=document.getElementById("delete-modal"),f=document.getElementById("delete-cancel-btn"),c=document.getElementById("delete-confirm-btn");f&&f.addEventListener("click",B),a&&a.addEventListener("click",i=>{i.target===a&&B()}),c&&c.addEventListener("click",async()=>{if(!w)return;const i=c.innerHTML;c.disabled=!0,c.innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{const d=await fetch(`${p}/posts/${w}`,{method:"DELETE",headers:{Authorization:`Bearer ${g}`}});if(!d.ok){const m=await d.json();throw new Error(m.error||"Delete failed")}l("Post deleted successfully!","success"),B(),C()}catch(d){console.error("Error deleting post:",d),l(`Error: ${d.message}`,"error")}finally{c.disabled=!1,c.innerHTML=i}})});function M(e=null){const t=document.getElementById("post-form"),o=document.getElementById("write-title"),s=document.getElementById("write-subtitle");if(t.reset(),t.postid.value="",document.querySelector(".btn-text").textContent="Save Post",e){o.textContent="Edit Post",s.textContent="Update your post",t.title.value=e.title||"",t.content.value=e.content||"",t.ispublished.checked=e.ispublished===1||e.ispublished===!0,t.postid.value=e.postid;const a=e.main_image_url;a&&(document.getElementById("current-image-url").value=a,document.getElementById("image-preview-text").textContent=`Current: ${a.split("/").pop()}`,document.getElementById("image-preview-text").style.display="block")}else o.textContent="New Post",s.textContent="Share your thoughts with the world",document.getElementById("image-preview-text").style.display="none";const n=document.getElementById("categories-checkboxes"),r=e?.categories||[];if(n.innerHTML=b.map(a=>{const f=r.includes(a.name);return`
            <label>
                <input type="checkbox" class="category-checkbox" name="categories" value="${a.category_id}" 
                ${f?"checked":""}>
                ${a.name}
            </label>
        `}).join(""),!document.getElementById("post-content-editor")){console.error("Editor element not found in DOM"),l("Editor failed to load","error");return}}async function C(){S();const e=document.getElementById("posts-container");try{const t=await fetch(`${p}/posts?blogger_id=${v}`,{headers:{Authorization:`Bearer ${g}`}});if(!t.ok){const n=await t.json();throw new Error(n.error||"Failed to load posts")}const o=await t.json();if(!Array.isArray(o))throw new Error("Invalid posts data");if(e.innerHTML="",o.length===0){e.innerHTML=`
            <a href="#" class="addpost-card" onclick="document.getElementById('add-post-btn').click(); return false;"> <div class="onboarding-card">
                <div class="card-icon write-icon">
                  <i class="fas fa-pen-fancy"></i>
                </div>
                <h3>Create Your First Post</h3>
                <!-- <p>Share your thoughts, ideas, and expertise with your audience</p>
                <button class="onboarding-btn" data-action="write">
                  Start Writing
                  <i class="fas fa-arrow-right"></i>
                </button> -->
              </div>
              </a>`,E();return}const s=o.map(n=>`
            <div class="post-card" data-post-id="${n.postid}">
                <div class="post-card-header">
                    <h4 class="posts-heading-prev">${n.title}</h4>
                </div>
                <div class="post-card-body">
                    <p class="posts-content-prev">${n.content_preview||n.content}</p>
                </div>
                <div class="post-card-footer">
                    <div class="details-meta">
                        <small><i class="fas fa-calendar"></i> ${new Date(n.created_at).toLocaleDateString()}</small>
                        <span class="status ${n.ispublished?"published":"draft"}">
                            <i class="fas"></i> ${n.ispublished?"Published":"Draft"}
                        </span>
                    </div>
                    <div class="actions">
                        <button class="btn-edit" type="button" title="Edit post">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn-delete" type="button" title="Delete post">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `).join("");e.innerHTML=s}catch(t){console.error("Error loading posts:",t),e.innerHTML=`<div class="state-message" style="background: var(--border-color); padding: 32px; border-radius: var(--btn-border-radius); text-align: center; grid-column: 1/-1; color: #d32f2f;">
					      <i class="fas fa-exclamation-triangle"></i>
						  <p>Error loading posts: ${t.message}</p>
						  <p> click <a href="/auth/signup.html">here to login </a> again to initialise a new token</p>
						  </div>`}finally{E()}}let b=[];async function H(){try{const e=await fetch(`${p}/categories`);if(!e.ok)throw new Error(`Failed to fetch categories: ${e.status}`);if(b=await e.json(),!Array.isArray(b))throw new Error("Categories response is not an array");console.log(`Successfully loaded ${b.length} categories`)}catch(e){console.error("Failed to load categories:",e),l("Failed to load categories.","error")}}async function j(e){e.preventDefault();const t=e.target,o=t.querySelector('button[type="submit"]');if(!o){console.error("Submit button not found");return}const s=o.querySelector(".btn-text"),n=o.querySelector(".btn-spinner");o.disabled=!0,s&&(s.textContent="Saving..."),n&&(n.style.display="inline-block");try{let r="";try{const h=tinymce.get("post-content-editor");h?(r=h.getContent(),console.log("Content from TinyMCE editor")):(r=t.content.value||"",console.log("Content from textarea fallback"))}catch(h){console.warn("Error getting TinyMCE content:",h),r=t.content.value||""}if(!r.replace(/<[^>]+>/g,"").replace(/&nbsp;|\u00A0/g," ").replace(/\s+/g," ").trim()){l("Post content cannot be empty.","error"),o.disabled=!1,s&&(s.textContent="Save Post"),n&&(n.style.display="none");return}const a=new FormData;a.append("title",t.title.value.trim()),a.append("content",r),a.append("is_published",t.ispublished.checked?1:0),Array.from(t.querySelectorAll('input[name="categories"]:checked')).map(h=>parseInt(h.value)).forEach(h=>a.append("categories[]",h));const c=document.getElementById("image-file-input"),i=document.getElementById("current-image-url"),d=i?i.value:"";c&&c.files.length>0?a.append("image_file",c.files[0]):d&&a.append("main_image_url",d);const m=t.postid.value,x=m?`${p}/posts/${m}`:`${p}/posts`;m&&a.append("_method","PUT");const k=await fetch(x,{method:"POST",headers:{Authorization:`Bearer ${g}`},body:a}),A=await k.json();if(!k.ok)throw new Error(A.error||"Failed to save post");l(`Post ${m?"updated":"created"} successfully!`,"success"),t.reset();const T=document.querySelectorAll(".nav-link");y("posts",T),C()}catch(r){console.error("Error submitting post:",r),l(`Error: ${r.message}`,"error")}finally{o.disabled=!1,s&&(s.textContent="Save Post"),n&&(n.style.display="none")}}async function F(e){S();try{const t=await fetch(`${p}/posts/${e}`,{headers:{Authorization:`Bearer ${g}`}});if(!t.ok){const n=await t.json();throw new Error(n.error||"Failed to fetch post")}const o=await t.json();console.log("Editing post:",o),I=o;const s=document.querySelectorAll(".nav-link");y("write",s)}catch(t){console.error("Error editing post:",t),l(`Error: ${t.message}`,"error")}finally{E()}}async function q(e){w=e;try{const t=await fetch(`${p}/posts/${e}`,{headers:{Authorization:`Bearer ${g}`}});if(!t.ok)throw new Error("Failed to fetch post");const o=await t.json();document.getElementById("delete-post-title").textContent=o.title,document.getElementById("delete-post-date").textContent=`Created on ${new Date(o.created_at).toLocaleDateString()}`,z()}catch(t){console.error("Error fetching post:",t),l("Error loading post details","error")}}function z(){const e=document.getElementById("delete-modal");e&&(e.classList.remove("hidden"),document.body.style.overflow="hidden")}function B(){const e=document.getElementById("delete-modal");e&&(e.classList.add("hidden"),document.body.style.overflow="auto"),w=null}async function L(){try{const e=await fetch(`${p}/blogger`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok){const r=await e.json();throw new Error(r.error||"Failed to load profile")}const t=await e.json(),o=document.getElementById("profile-display-name"),s=document.getElementById("profile-display-email");o&&(o.textContent=t.full_name||"Blogger"),s&&(s.textContent=t.email||"");const n=document.getElementById("account-form");n&&(n.full_name.value=t.full_name||"",n.email.value=t.email||"",n.username.value=t.username||"",n.phone.value=t.phone||"",n.bio.value=t.bio||"",n.website.value=t.website||"",P()),O(),V(),W(),U()}catch(e){console.error("Error loading profile:",e),l(`Error: ${e.message}`,"error")}}function U(){const e=document.querySelectorAll(".profile-tab-btn"),t=document.querySelectorAll(".profile-tab-content");e.forEach(o=>{o.addEventListener("click",()=>{const s=o.dataset.tab;e.forEach(n=>n.classList.remove("active")),o.classList.add("active"),t.forEach(n=>n.classList.remove("active")),document.getElementById(`${s}-tab`).classList.add("active")})})}function O(){const e=document.getElementById("account-form");if(!e)return;const t=e.bio;t&&t.addEventListener("input",P),e.addEventListener("submit",async s=>{s.preventDefault();const n=e.querySelector('button[type="submit"]'),r=n.innerHTML;n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';try{const u={full_name:e.full_name.value.trim(),email:e.email.value.trim(),username:e.username.value.trim(),phone:e.phone.value.trim()||null,bio:e.bio.value.trim()||null,website:e.website.value.trim()||null},a=await fetch(`${p}/blogger`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify(u)});if(!a.ok){const f=await a.json();throw new Error(f.error||"Update failed")}l("Profile updated successfully!","success"),L()}catch(u){console.error("Error updating profile:",u),l(`Error: ${u.message}`,"error")}finally{n.disabled=!1,n.innerHTML=r}});const o=document.getElementById("reset-account-btn");o&&o.addEventListener("click",()=>{L()})}function V(){const e=document.getElementById("toggle-password-form"),t=document.getElementById("password-form"),o=document.getElementById("cancel-password-btn");e&&e.addEventListener("click",()=>{t.classList.toggle("hidden"),e.textContent=t.classList.contains("hidden")?"Change Password":"Hide"}),o&&o.addEventListener("click",()=>{t.classList.add("hidden"),e&&(e.textContent="Change Password"),t.reset()}),document.querySelectorAll(".password-toggle").forEach(r=>{r.addEventListener("click",u=>{u.preventDefault();const a=r.dataset.target,f=document.getElementById(a),c=f.type==="password";f.type=c?"text":"password",r.innerHTML=c?'<i class="fas fa-eye-slash"></i>':'<i class="fas fa-eye"></i>'})});const s=document.getElementById("new-password");s&&s.addEventListener("input",J),t.addEventListener("submit",async r=>{r.preventDefault();const u=document.getElementById("current-password").value,a=document.getElementById("new-password").value,f=document.getElementById("confirm-password").value;if(a!==f){l("New passwords do not match","error");return}if(a.length<8){l("Password must be at least 8 characters","error");return}const c=t.querySelector('button[type="submit"]'),i=c.innerHTML;c.disabled=!0,c.innerHTML='<i class="fas fa-spinner fa-spin"></i> Updating...';try{const d=await fetch(`${p}/admin/change-password`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify({current_password:u,new_password:a})});if(!d.ok){const m=await d.json();throw new Error(m.error||"Password update failed")}l("Password updated successfully!","success"),t.reset(),t.classList.add("hidden"),document.getElementById("toggle-password-form").textContent="Change Password"}catch(d){console.error("Error updating password:",d),l(`Error: ${d.message}`,"error")}finally{c.disabled=!1,c.innerHTML=i}});const n=document.getElementById("enable-2fa-btn");n&&n.addEventListener("click",()=>{l("Two-factor authentication is coming soon!","info")})}function W(){const e=document.getElementById("preferences-form");e&&e.addEventListener("click",()=>{l("Preference settings comming soon!","info")});const t=document.getElementById("delete-account-btn");t&&t.addEventListener("click",()=>{l("Account deletion is coming soon","info")})}function P(){const e=document.getElementById("profile-bio"),t=document.getElementById("bio-char-count");e&&t&&(t.textContent=e.value.length)}function J(){const e=document.getElementById("new-password").value,t=document.getElementById("strength-indicator"),o=document.getElementById("strength-text");let s="Weak",n="weak";if(e.length>=8){const r=/[A-Z]/.test(e),u=/[a-z]/.test(e),a=/[0-9]/.test(e),f=/[!@#$%^&*]/.test(e),c=[r,u,a,f].filter(Boolean).length;c>=3?(s="Strong",n="strong"):c>=2&&(s="Medium",n="medium")}t.className=`strength-indicator ${n}`,o.textContent=`Password strength: ${s}`}async function R(){try{const e=await fetch(`${p}/blogger`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok)return;const t=await e.json(),o=document.getElementById("blogger-name");o&&t.full_name&&(o.textContent=t.full_name.split(" ")[0])}catch(e){console.error("Error loading blogger name:",e)}}async function N(){try{const e=await fetch(`${p}/posts?blogger_id=${v}`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok)return;const t=await e.json();if(!Array.isArray(t))return;const o=t.length,s=t.filter(u=>u.ispublished===1||u.ispublished===!0).length,n=document.getElementById("stat-posts"),r=document.getElementById("stat-published");n&&(n.textContent=o),r&&(r.textContent=s),Y()}catch(e){console.error("Error loading dashboard stats:",e)}}async function Y(){try{const e=await fetch(`${p}/subscribers?blogger_id=${v}`,{headers:{Authorization:`Bearer ${g}`}});if(!e.ok)return;const t=await e.json(),o=Array.isArray(t)?t.length:0,s=document.getElementById("stat-subscribers");s&&(s.textContent=o)}catch{console.log("Note: Subscriber endpoint may not be available yet"),l("Note: Subscriber endpoint may not be available yet","info")}}
